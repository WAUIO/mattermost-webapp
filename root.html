<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' cdn.segment.com/analytics.js/ 'unsafe-eval' 'nonce-4AEemGb0xJptoIGFP3Nb'">

    <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0'>
    <meta name='robots' content='noindex, nofollow'>
    <meta name='referrer' content='no-referrer'>

    <title>WAU Chat</title>

    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='application-name' content='WAU Chat'>
    <meta name='format-detection' content='telephone=no'>
    <link rel="icon" type="image/png" href='/static/icon_32x32.png'>

    <link rel="icon" type="image/png" href="/static/images/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/static/images/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/static/images/favicon/favicon-96x96.png" sizes="96x96">

    <!-- CSS Should always go first -->
    <link rel='stylesheet' class='code_theme'>
    <style>
        .error-screen {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            padding-top: 50px;
            max-width: 750px;
            font-size: 14px;
            color: #333333;
            margin: auto;
            display: none;
            line-height: 1.5;
        }

        .error-screen h2 {
            font-size: 30px;
            font-weight: normal;
            line-height: 1.2;
        }

        .error-screen ul {
            padding-left: 15px;
            line-height: 1.7;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .error-screen hr {
            color: #ddd;
            margin-top: 20px;
            margin-bottom: 20px;
            border: 0;
            border-top: 1px solid #eee;
        }

        .error-screen-visible {
            display: block;
        }
    </style>
</head>
<body class='font--open_sans'>
    <div id='root'>
        <div class='error-screen'>
            <h2>Cannot connect to WAU Chat</h2>
            <hr/>
            <p>We're having trouble connecting to Wau Chat. If refreshing this page (Ctrl+R or Command+R) does not work, please verify that your computer is connected to the internet.</p>
            <br/>
        </div>
        <div
            class='loading-screen'
            style='position: relative'
        >
            <div class='loading__content'>
                <div class='round round-1'></div>
                <div class='round round-2'></div>
                <div class='round round-3'></div>
            </div>
        </div>
    </div>
    <script type='text/javascript' nonce="4AEemGb0xJptoIGFP3Nb">
        // addEventListener support for IE8
        function bindEvent(element, eventName, eventHandler) {
            if (element.addEventListener) {
                element.addEventListener(eventName, eventHandler, false);
            } else if (element.attachEvent) {
                element.attachEvent('on' + eventName, eventHandler);
            }
        }

        function setUserCookies(messageObj){
            return new Promise((resolve, reject) => {
                    try{
                        //set the cookies
                        document.cookie = `MMAUTHTOKEN=${messageObj.MMAUTHTOKEN}; path=/`;
                        document.cookie = `MMUSERID=${messageObj.MMUSERID}; path=/`;
                        setTimeout(() => {
                            resolve(document.cookie);
                        }, 10) 
                    }catch(e){
                        reject(e);
                    }                
            });
        } 

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            
            return "";
        }

        bindEvent(window, 'load', (e) => {
            if (window.parent !== null) {
                console.log('Initializing com with parent...');
                window.parent.postMessage('WAUCHAT_READY', '*');
            }
        })
    
        // Listen to post message events and if a cookie, set it and refresh it self
        bindEvent(window, 'message', (e) => {
            //check the message
            try {
                var messageObj = JSON.parse(e.data);
                if (
                    typeof messageObj === 'object' &&
                    messageObj.hasOwnProperty('referer') &&
                    messageObj.referer === 'Portal' &&
                    messageObj.hasOwnProperty('MMAUTHTOKEN') &&
                    messageObj.hasOwnProperty('MMUSERID')
                ) {
                    var connectedUser = getCookie('MMUSERID');
                    if (connectedUser !== messageObj.MMUSERID && connectedUser.length > 1){
                        var req = new Request(`${window.location.origin}/api/v4/users/logout`, {method:"POST", credentials: "include"});
                        fetch(req).then((response) => {
                            setUserCookies(messageObj).then((result) => {
                                //reload self
                                self.location.reload();
                            }).catch((error) => {
                                console.log("Cookie flow error", error);
                            });                           
                        })
                    } else {
                        setUserCookies(messageObj).then((result) => {
                            //reload self
                            self.location.reload();
                        }).catch((error) => {
                            console.log("Cookie flow error", error);
                        });           
                    }
                }
            } catch (ex) {console.error(e)}
        });
    </script>
    <div id='root-portal'></div>
    <noscript>
        To use Wau Chat, please enable JavaScript.
    </noscript>
</body>
</html>
